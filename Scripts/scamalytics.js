// å®šä¹‰å›½å®¶æ——å¸œæ˜ å°„
var flags = new Map([
    ["AC", "ğŸ‡¦ğŸ‡¨"], ["AE", "ğŸ‡¦ğŸ‡ª"], ["AF", "ğŸ‡¦ğŸ‡«"], ["AI", "ğŸ‡¦ğŸ‡®"], ["AL", "ğŸ‡¦ğŸ‡±"],
    ["AM", "ğŸ‡¦ğŸ‡²"], ["AQ", "ğŸ‡¦ğŸ‡¶"], ["AR", "ğŸ‡¦ğŸ‡·"], ["AS", "ğŸ‡¦ğŸ‡¸"], ["AT", "ğŸ‡¦ğŸ‡¹"],
    ["AU", "ğŸ‡¦ğŸ‡º"], ["AW", "ğŸ‡¦ğŸ‡¼"], ["AX", "ğŸ‡¦ğŸ‡½"], ["AZ", "ğŸ‡¦ğŸ‡¿"], ["BA", "ğŸ‡§ğŸ‡¦"],
    ["BB", "ğŸ‡§ğŸ‡§"], ["BD", "ğŸ‡§ğŸ‡©"], ["BE", "ğŸ‡§ğŸ‡ª"], ["BF", "ğŸ‡§ğŸ‡«"], ["BG", "ğŸ‡§ğŸ‡¬"],
    ["BH", "ğŸ‡§ğŸ‡­"], ["BI", "ğŸ‡§ğŸ‡®"], ["BJ", "ğŸ‡§ğŸ‡¯"], ["BM", "ğŸ‡§ğŸ‡²"], ["BN", "ğŸ‡§ğŸ‡³"],
    ["BO", "ğŸ‡§ğŸ‡´"], ["BR", "ğŸ‡§ğŸ‡·"], ["BS", "ğŸ‡§ğŸ‡¸"], ["BT", "ğŸ‡§ğŸ‡¹"], ["BV", "ğŸ‡§ğŸ‡»"],
    ["BW", "ğŸ‡§ğŸ‡¼"], ["BY", "ğŸ‡§ğŸ‡¾"], ["BZ", "ğŸ‡§ğŸ‡¿"], ["CA", "ğŸ‡¨ğŸ‡¦"], ["CF", "ğŸ‡¨ğŸ‡«"],
    ["CH", "ğŸ‡¨ğŸ‡­"], ["CK", "ğŸ‡¨ğŸ‡°"], ["CL", "ğŸ‡¨ğŸ‡±"], ["CM", "ğŸ‡¨ğŸ‡²"], ["CN", "ğŸ‡¨ğŸ‡³"],
    ["CO", "ğŸ‡¨ğŸ‡´"], ["CP", "ğŸ‡¨ğŸ‡µ"], ["CR", "ğŸ‡¨ğŸ‡·"], ["CU", "ğŸ‡¨ğŸ‡º"], ["CV", "ğŸ‡¨ğŸ‡»"],
    ["CX", "ğŸ‡¨ğŸ‡½"], ["CY", "ğŸ‡¨ğŸ‡¾"], ["CZ", "ğŸ‡¨ğŸ‡¿"], ["DE", "ğŸ‡©ğŸ‡ª"], ["DJ", "ğŸ‡©ğŸ‡¯"],
    ["DK", "ğŸ‡©ğŸ‡°"], ["DM", "ğŸ‡©ğŸ‡²"], ["DO", "ğŸ‡©ğŸ‡´"], ["DZ", "ğŸ‡©ğŸ‡¿"], ["EC", "ğŸ‡ªğŸ‡¨"],
    ["EE", "ğŸ‡ªğŸ‡ª"], ["EG", "ğŸ‡ªğŸ‡¬"], ["EH", "ğŸ‡ªğŸ‡­"], ["ER", "ğŸ‡ªğŸ‡·"], ["ES", "ğŸ‡ªğŸ‡¸"],
    ["ET", "ğŸ‡ªğŸ‡¹"], ["FI", "ğŸ‡«ğŸ‡®"], ["FJ", "ğŸ‡«ğŸ‡¯"], ["FM", "ğŸ‡«ğŸ‡²"], ["FO", "ğŸ‡«ğŸ‡´"],
    ["FR", "ğŸ‡«ğŸ‡·"], ["GA", "ğŸ‡¬ğŸ‡¦"], ["GB", "ğŸ‡¬ğŸ‡§"], ["GD", "ğŸ‡¬ğŸ‡©"], ["GE", "ğŸ‡¬ğŸ‡ª"],
    ["GF", "ğŸ‡¬ğŸ‡«"], ["GG", "ğŸ‡¬ğŸ‡¬"], ["GH", "ğŸ‡¬ğŸ‡­"], ["GI", "ğŸ‡¬ğŸ‡®"], ["GL", "ğŸ‡¬ğŸ‡±"],
    ["GM", "ğŸ‡¬ğŸ‡²"], ["GN", "ğŸ‡¬ğŸ‡³"], ["GP", "ğŸ‡¬ğŸ‡µ"], ["GQ", "ğŸ‡¬ğŸ‡¶"], ["GR", "ğŸ‡¬ğŸ‡·"],
    ["GT", "ğŸ‡¬ğŸ‡¹"], ["GU", "ğŸ‡¬ğŸ‡º"], ["GW", "ğŸ‡¬ğŸ‡¼"], ["GY", "ğŸ‡¬ğŸ‡¾"], ["HK", "ğŸ‡­ğŸ‡°"],
    ["HM", "ğŸ‡­ğŸ‡²"], ["HN", "ğŸ‡­ğŸ‡³"], ["HR", "ğŸ‡­ğŸ‡·"], ["HT", "ğŸ‡­ğŸ‡¹"], ["HU", "ğŸ‡­ğŸ‡º"],
    ["ID", "ğŸ‡®ğŸ‡©"], ["IE", "ğŸ‡®ğŸ‡ª"], ["IL", "ğŸ‡®ğŸ‡±"], ["IM", "ğŸ‡®ğŸ‡²"], ["IN", "ğŸ‡®ğŸ‡³"],
    ["IO", "ğŸ‡®ğŸ‡´"], ["IQ", "ğŸ‡®ğŸ‡¶"], ["IR", "ğŸ‡®ğŸ‡·"], ["IS", "ğŸ‡®ğŸ‡¸"], ["IT", "ğŸ‡®ğŸ‡¹"],
    ["JE", "ğŸ‡¯ğŸ‡ª"], ["JM", "ğŸ‡¯ğŸ‡²"], ["JO", "ğŸ‡¯ğŸ‡´"], ["JP", "ğŸ‡¯ğŸ‡µ"], ["KE", "ğŸ‡°ğŸ‡ª"],
    ["KG", "ğŸ‡°ğŸ‡¬"], ["KH", "ğŸ‡°ğŸ‡­"], ["KI", "ğŸ‡°ğŸ‡·"], ["KM", "ğŸ‡°ğŸ‡²"], ["KN", "ğŸ‡°ğŸ‡³"],
    ["KP", "ğŸ‡°ğŸ‡µ"], ["KR", "ğŸ‡°ğŸ‡·"], ["KW", "ğŸ‡°ğŸ‡¼"], ["KY", "ğŸ‡°ğŸ‡¾"], ["KZ", "ğŸ‡°ğŸ‡¿"],
    ["LA", "ğŸ‡±ğŸ‡¦"], ["LB", "ğŸ‡±ğŸ‡§"], ["LC", "ğŸ‡±ğŸ‡¨"], ["LI", "ğŸ‡±ğŸ‡®"], ["LK", "ğŸ‡±ğŸ‡°"],
    ["LR", "ğŸ‡±ğŸ‡·"], ["LS", "ğŸ‡±ğŸ‡¸"], ["LT", "ğŸ‡±ğŸ‡¹"], ["LU", "ğŸ‡±ğŸ‡º"], ["LV", "ğŸ‡±ğŸ‡»"],
    ["LY", "ğŸ‡±ğŸ‡¾"], ["MA", "ğŸ‡²ğŸ‡¦"], ["MC", "ğŸ‡²ğŸ‡¨"], ["MD", "ğŸ‡²ğŸ‡©"], ["ME", "ğŸ‡²ğŸ‡ª"],
    ["MF", "ğŸ‡²ğŸ‡«"], ["MG", "ğŸ‡²ğŸ‡¬"], ["MH", "ğŸ‡²ğŸ‡­"], ["MK", "ğŸ‡²ğŸ‡°"], ["ML", "ğŸ‡²ğŸ‡±"],
    ["MM", "ğŸ‡²ğŸ‡²"], ["MN", "ğŸ‡²ğŸ‡³"], ["MO", "ğŸ‡²ğŸ‡´"], ["MP", "ğŸ‡²ğŸ‡µ"], ["MQ", "ğŸ‡²ğŸ‡¶"],
    ["MR", "ğŸ‡²ğŸ‡·"], ["MS", "ğŸ‡²ğŸ‡¸"], ["MT", "ğŸ‡²ğŸ‡¹"], ["MU", "ğŸ‡²ğŸ‡º"], ["MV", "ğŸ‡²ğŸ‡»"],
    ["MW", "ğŸ‡²ğŸ‡¼"], ["MX", "ğŸ‡²ğŸ‡½"], ["MY", "ğŸ‡²ğŸ‡¾"], ["MZ", "ğŸ‡²ğŸ‡¿"], ["NA", "ğŸ‡³ğŸ‡¦"],
    ["NC", "ğŸ‡³ğŸ‡¨"], ["NE", "ğŸ‡³ğŸ‡ª"], ["NF", "ğŸ‡³ğŸ‡«"], ["NG", "ğŸ‡³ğŸ‡¬"], ["NI", "ğŸ‡³ğŸ‡®"],
    ["NL", "ğŸ‡³ğŸ‡±"], ["NO", "ğŸ‡³ğŸ‡´"], ["NP", "ğŸ‡³ğŸ‡µ"], ["NR", "ğŸ‡³ğŸ‡·"], ["NU", "ğŸ‡³ğŸ‡º"],
    ["NZ", "ğŸ‡³ğŸ‡¿"], ["OM", "ğŸ‡´ğŸ‡²"], ["PA", "ğŸ‡µğŸ‡¦"], ["PE", "ğŸ‡µğŸ‡ª"], ["PF", "ğŸ‡µğŸ‡«"],
    ["PG", "ğŸ‡µğŸ‡¬"], ["PH", "ğŸ‡µğŸ‡­"], ["PK", "ğŸ‡µğŸ‡°"], ["PL", "ğŸ‡µğŸ‡±"], ["PM", "ğŸ‡µğŸ‡²"],
    ["PN", "ğŸ‡µğŸ‡³"], ["PR", "ğŸ‡µğŸ‡·"], ["PT", "ğŸ‡µğŸ‡¹"], ["PW", "ğŸ‡µğŸ‡¼"], ["PY", "ğŸ‡µğŸ‡¾"],
    ["QA", "ğŸ‡¶ğŸ‡¦"], ["RE", "ğŸ‡·ğŸ‡ª"], ["RO", "ğŸ‡·ğŸ‡´"], ["RS", "ğŸ‡·ğŸ‡¸"], ["RU", "ğŸ‡·ğŸ‡º"],
    ["RW", "ğŸ‡·ğŸ‡¼"], ["SA", "ğŸ‡¸ğŸ‡¦"], ["SB", "ğŸ‡¸ğŸ‡§"], ["SC", "ğŸ‡¸ğŸ‡¨"], ["SD", "ğŸ‡¸ğŸ‡©"],
    ["SE", "ğŸ‡¸ğŸ‡ª"], ["SG", "ğŸ‡¸ğŸ‡¬"], ["SH", "ğŸ‡¸ğŸ‡­"], ["SI", "ğŸ‡¸ğŸ‡®"], ["SJ", "ğŸ‡¸ğŸ‡¯"],
    ["SK", "ğŸ‡¸ğŸ‡°"], ["SL", "ğŸ‡¸ğŸ‡±"], ["SM", "ğŸ‡¸ğŸ‡²"], ["SN", "ğŸ‡¸ğŸ‡³"], ["SO", "ğŸ‡¸ğŸ‡´"],
    ["SR", "ğŸ‡¸ğŸ‡·"], ["SS", "ğŸ‡¸ğŸ‡¸"], ["ST", "ğŸ‡¸ğŸ‡¹"], ["SV", "ğŸ‡¸ğŸ‡»"], ["SX", "ğŸ‡¸ğŸ‡½"],
    ["SY", "ğŸ‡¸ğŸ‡¾"], ["SZ", "ğŸ‡¸ğŸ‡¿"], ["TC", "ğŸ‡¹ğŸ‡¨"], ["TD", "ğŸ‡¹ğŸ‡©"], ["TF", "ğŸ‡¹ğŸ‡«"],
    ["TG", "ğŸ‡¹ğŸ‡¬"], ["TH", "ğŸ‡¹ğŸ‡­"], ["TJ", "ğŸ‡¹ğŸ‡¯"], ["TK", "ğŸ‡¹ğŸ‡°"], ["TL", "ğŸ‡¹ğŸ‡±"],
    ["TM", "ğŸ‡¹ğŸ‡²"], ["TN", "ğŸ‡¹ğŸ‡³"], ["TO", "ğŸ‡¹ğŸ‡´"], ["TR", "ğŸ‡¹ğŸ‡·"], ["TT", "ğŸ‡¹ğŸ‡¹"],
    ["TV", "ğŸ‡¹ğŸ‡»"], ["TZ", "ğŸ‡¹ğŸ‡¿"], ["UA", "ğŸ‡ºğŸ‡¦"], ["UG", "ğŸ‡ºğŸ‡¬"], ["UM", "ğŸ‡ºğŸ‡²"],
    ["US", "ğŸ‡ºğŸ‡¸"], ["UY", "ğŸ‡ºğŸ‡¾"], ["UZ", "ğŸ‡ºğŸ‡¿"], ["VA", "ğŸ‡»ğŸ‡¦"], ["VC", "ğŸ‡»ğŸ‡¨"],
    ["VE", "ğŸ‡»ğŸ‡ª"], ["VG", "ğŸ‡»ğŸ‡¬"], ["VI", "ğŸ‡»ğŸ‡®"], ["VN", "ğŸ‡»ğŸ‡³"], ["VU", "ğŸ‡»ğŸ‡º"],
    ["WF", "ğŸ‡¼ğŸ‡«"], ["WS", "ğŸ‡¼ğŸ‡¸"], ["YE", "ğŸ‡¾ğŸ‡ª"], ["YT", "ğŸ‡¾ğŸ‡¹"], ["ZA", "ğŸ‡¿ğŸ‡¦"],
    ["ZM", "ğŸ‡¿ğŸ‡²"], ["ZW", "ğŸ‡¿ğŸ‡¼"]
    // å¯ä»¥ç»§ç»­æ·»åŠ æ›´å¤šå›½å®¶
]);

const ipUrl = "http://ip-api.com/json/"; // å®šä¹‰è·å–IPä¿¡æ¯çš„APIåœ°å€
const scamUrl = "https://api11.scamalytics.com/shaoxinweixuer/?key=3d803bd1825826b88353d677e37d5f54ee5685e242347e88b8159c103bbc5ef1&ip="; // å®šä¹‰è·å–IPæ¬ºè¯ˆä¿¡æ¯çš„APIåœ°å€

// è·å–å½“å‰èŠ‚ç‚¹åç§°
const nodeName = $environment.params || 'æœªçŸ¥èŠ‚ç‚¹'; // ä»ç¯å¢ƒå‚æ•°ä¸­è·å–èŠ‚ç‚¹åç§°ï¼Œå¦‚æœæ²¡æœ‰åˆ™è®¾ä¸º'æœªçŸ¥èŠ‚ç‚¹'

// è®¾ç½®è¯·æ±‚å‚æ•°
const requestParams = {
    url: ipUrl, // è¯·æ±‚çš„URL
    headers: {
        'User-Agent': 'Quantumult X' // è®¾ç½®User-Agentå¤´
    },
    opts: {
        policy: $environment.params, // æ·»åŠ optsé€‰é¡¹ï¼Œé…ç½®è¯·æ±‚ç­–ç•¥
    }
};

// å‘é€è¯·æ±‚è·å–IPä¿¡æ¯
$task.fetch(requestParams).then(response => { // å‘é€è¯·æ±‚å¹¶å¤„ç†å“åº”
    const ipInfo = JSON.parse(response.body); // è§£æå“åº”ä½“ä¸ºJSONå¯¹è±¡
    const ip = ipInfo.query; // è·å–æŸ¥è¯¢åˆ°çš„IPåœ°å€
    const scamRequestParams = {
        url: scamUrl + ip, // æ‹¼æ¥è·å–æ¬ºè¯ˆä¿¡æ¯çš„URL
        headers: {
            'User-Agent': 'Quantumult X' // è®¾ç½®User-Agentå¤´
        },
        opts: {
            policy: $environment.params, // åœ¨è¿™é‡Œä¹Ÿæ·»åŠ optsé€‰é¡¹
        }
    };

    // å‘é€è¯·æ±‚è·å–æ¬ºè¯ˆåˆ†æ•°
    $task.fetch(scamRequestParams).then(response => { // å‘é€æ¬ºè¯ˆåˆ†æ•°è¯·æ±‚å¹¶å¤„ç†å“åº”
        const scamInfo = JSON.parse(response.body); // è§£æå“åº”ä½“ä¸ºJSONå¯¹è±¡
        const countryCode = scamInfo.ip_country_code; // è·å–å›½å®¶ä»£ç 
        const countryFlag = flags.get(countryCode) || '';  // è·å–å›½å®¶æ——å¸œï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸ºç©º

        // ç¡®å®šé£é™©ç­‰çº§çš„ emoji å’Œæè¿°
        let riskemoji; // å®šä¹‰é£é™©è¡¨æƒ…å˜é‡
        let riskDescription; // å®šä¹‰é£é™©æè¿°å˜é‡
        switch (scamInfo.risk) { // æ ¹æ®é£é™©ç­‰çº§è®¾ç½®è¡¨æƒ…å’Œæè¿°
            case 'very high':
                riskemoji = 'ğŸ”´'; // è®¾ç½®éå¸¸é«˜é£é™©è¡¨æƒ…
                riskDescription = 'éå¸¸é«˜é£é™©'; // è®¾ç½®é£é™©æè¿°
                break;
            case 'high':
                riskemoji = 'ğŸŸ '; // è®¾ç½®é«˜é£é™©è¡¨æƒ…
                riskDescription = 'é«˜é£é™©'; // è®¾ç½®é£é™©æè¿°
                break;
            case 'medium':
                riskemoji = 'ğŸŸ¡'; // è®¾ç½®ä¸­ç­‰é£é™©è¡¨æƒ…
                riskDescription = 'ä¸­ç­‰é£é™©'; // è®¾ç½®é£é™©æè¿°
                break;
            case 'low':
                riskemoji = 'ğŸŸ¢'; // è®¾ç½®ä½é£é™©è¡¨æƒ…
                riskDescription = 'ä½é£é™©'; // è®¾ç½®é£é™©æè¿°
                break;
            default:
                riskemoji = 'âšª'; // è®¾ç½®æœªçŸ¥é£é™©è¡¨æƒ…
                riskDescription = 'æœªçŸ¥é£é™©'; // è®¾ç½®é£é™©æè¿°
        }

        // å‡†å¤‡HTMLå†…å®¹ä»¥åœ¨QXé¢æ¿ä¸­æ˜¾ç¤º
        const resultHtml = `
        <p style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; padding-left: 5ch;">
            <br> <!-- æ·»åŠ ä¸€ä¸ªç©ºè¡Œ -->
            
            <b>IPåœ°å€ï¼š</b>${scamInfo.ip}<br> <!-- æ˜¾ç¤ºIPåœ°å€ -->
            <b>IPæ¬ºè¯ˆåˆ†æ•°ï¼š</b>${scamInfo.score}<br> <!-- æ˜¾ç¤ºIPæ¬ºè¯ˆåˆ†æ•° -->
            <b>IPé£é™©ç­‰çº§ï¼š</b>${riskemoji} ${riskDescription}<br> <!-- æ˜¾ç¤ºé£é™©ç­‰çº§åŠå…¶è¡¨æƒ… -->
            <b>IPåŸå¸‚ï¼š</b>${scamInfo.ip_city}<br> <!-- æ˜¾ç¤ºIPæ‰€åœ¨åŸå¸‚ -->
            <b>IPå›½å®¶ï¼š</b>${countryFlag} ${countryCode}<br> <!-- æ˜¾ç¤ºIPå›½å®¶åŠå…¶æ——å¸œ -->
            <b>ISPåç§°ï¼š</b>${scamInfo['ISP Name']}<br> <!-- æ˜¾ç¤ºISPåç§° -->
            <b>ISPæ¬ºè¯ˆåˆ†æ•°ï¼š</b>${scamInfo['ISP Fraud Score']}<br> <!-- æ˜¾ç¤ºISPæ¬ºè¯ˆåˆ†æ•° -->
            <b>ASNç¼–å·ï¼š</b>${scamInfo.as_number}<br> <!-- æ˜¾ç¤ºASNç¼–å· -->
            <b>ASNæœºæ„ï¼š</b>${scamInfo['Organization Name']}<br> <!-- æ˜¾ç¤ºASNæœºæ„åç§° -->
            
            <br> <!-- æ·»åŠ ä¸€ä¸ªç©ºè¡Œ -->
            <b style="color: red;">èŠ‚ç‚¹ï¼š</b> âŸ <span style="color: red;">${nodeName}</span> <!-- æ˜¾ç¤ºå½“å‰èŠ‚ç‚¹åç§° -->
        </p>
    `;


        // å°†ç»“æœæ˜¾ç¤ºåœ¨QXé¢æ¿ä¸Š
        $done({ // å®Œæˆè¯·æ±‚ï¼Œè¿”å›ç»“æœ
            title: "IPæ¬ºè¯ˆåˆ†æŸ¥è¯¢", // è®¾ç½®é¢æ¿æ ‡é¢˜
            htmlMessage: resultHtml // è®¾ç½®é¢æ¿å†…å®¹ä¸ºç»“æœHTML
        });

    }).catch(error => { // å¤„ç†æ¬ºè¯ˆä¿¡æ¯è¯·æ±‚é”™è¯¯
        console.error(error); // æ‰“å°é”™è¯¯ä¿¡æ¯
        const errorMessage = "<p style='text-align: center;'>ğŸ”´ æŸ¥è¯¢è¶…æ—¶</p>"; // è®¾ç½®é”™è¯¯æ¶ˆæ¯
        $done({ // å®Œæˆè¯·æ±‚ï¼Œè¿”å›é”™è¯¯æ¶ˆæ¯
            title: "IPæ¬ºè¯ˆåˆ†æŸ¥è¯¢", // è®¾ç½®é¢æ¿æ ‡é¢˜
            htmlMessage: errorMessage // è®¾ç½®é¢æ¿å†…å®¹ä¸ºé”™è¯¯æ¶ˆæ¯
        });
    });
}).catch(error => { // å¤„ç†IPä¿¡æ¯è¯·æ±‚é”™è¯¯
    console.error(error); // æ‰“å°é”™è¯¯ä¿¡æ¯
    const errorMessage = "<p style='text-align: center;'>ğŸ”´ æŸ¥è¯¢è¶…æ—¶</p>"; // è®¾ç½®é”™è¯¯æ¶ˆæ¯
    $done({ // å®Œæˆè¯·æ±‚ï¼Œè¿”å›é”™è¯¯æ¶ˆæ¯
        title: "IPæ¬ºè¯ˆåˆ†æŸ¥è¯¢", // è®¾ç½®é¢æ¿æ ‡é¢˜
        htmlMessage: errorMessage // è®¾ç½®é¢æ¿å†…å®¹ä¸ºé”™è¯¯æ¶ˆæ¯
    });
});
